<template>
  <div class="comp-priceslider" @touchmove="handleMove" @touchend="handleEnd">
    <div class="comp-text" :style="{color:textColor}"><div class="com-price">{{currentMin}}<span v-if="btnNum==2">-{{CurMaxText}}</span></div></div>
    <div class="comp-outer">
      <div class="comp-line" :style="{background: lineColor}">
        <div class="comp-mask comp-mask-left" :style="'width: '+Left+'px;background:'+bgColor"></div>
        <div class="comp-mask comp-mask-right" :style="'width: '+Right+'px;background:'+bgColor"></div>
      </div>
      <div data-slider="left" class="comp-slider svg left" :style="'left: '+Left+'px'" @touchstart="handleDrag"></div>
      <div v-if="btnNum==2" data-slider="right" class="comp-slider svg right" :style="'right: '+Right+'px'" @touchstart="handleDrag"></div>
    </div>   
  </div>
</template>
<script>
export default {
  name: 'slider',
  data() {
    return {
    activeSlide: null,
    left: 0,
    right: 0,
    startPoint: null,
    lastPoint: null,
    moveLeft: 0,
    moveRight: 0,
    length: 200,
    scale: 1,
    currentMax: this.curMax,
    currentMin: this.curMin
    };
  },
  props: {
    minVal: {
      type: Number,
      default: 0
    },
    maxVal: {
      type: Number,
      default: 8100
    },
    curMin: {
      type: Number,
      default: 0
    },
    curMax: {
      type: Number,
      default: 8100
    },
    canFollow: {
      type: Boolean,
      default: true
    },
    lineColor: {
      type: String,
      default: "#b4986e"
    },
    textColor: {
      type: String,
      default: "#b4986e"
    },
    bgColor: {
      type: String,
      default: "#D8D8D8"
    },
    btnNum: {
      type: Number,
      default: 2
    }
  },
  computed: {
    Left() {
      let val = this.left + this.moveLeft;
      let maxLeft = this.canFollow ? this.Length : (this.Length - this.Right);
      return Math.max(0, Math.min(val, maxLeft));
    },
    Right() {
      let val = this.right - this.moveRight;
      let maxRight = this.canFollow ? this.Length : (this.Length - this.Left);
      return Math.max(0, Math.min(val, maxRight));
    },
    CurMaxText() {
      return this.currentMax == this.maxVal ? '不限' : this.currentMax + '元';
    },
    Length() {
      return Math.round(this.length * this.scale);
    },
    PerPriceByLength() {
      return this.maxVal / this.Length;
    },
    PerLengthByPrice() {
      return this.Length / this.maxVal;
    }
  },
  watch: {
    moveLeft() {
      let val = this.Left * this.PerPriceByLength;
      this.currentMin = Math.min(parseInt(Math.round(val) / 100) * 100, this.currentMax);
    },
    moveRight() {
      let val = (this.Length - this.Right) * this.PerPriceByLength;
      this.currentMax = Math.max(parseInt(Math.round(val) / 100) * 100, this.currentMin);
    }
  },
  methods: {
    getLeftByPrice(price) {
      return price * this.PerLengthByPrice;
    },
    getRightByPrice(price) {
      return this.Length - price * this.PerLengthByPrice;// (1 - price / this.maxVal) * this.Length
    },
    handleDrag(e) {
      if (e.target.dataset['slider']) {
        this.activeSlide = e.target;
        this.startPoint = this.lastPoint = e.touches[0].pageX;
      }
      // this.$emit('setScrollStatus', false);
    },
    handleMove(e) {
      let curPoint = e.touches[0].pageX;
      if (!this.activeSlide || !this.startPoint || this.timer) {
        return;
      }
      this.timer = setTimeout(() => {
        this.timer = null;
      }, 8);
      let moveDistance = curPoint - this.startPoint;
      if (this.activeSlide.dataset['slider'] == 'left') {
        if (this.currentMin >= this.currentMax && curPoint > this.lastPoint && this.canFollow) {
          this.moveRight = moveDistance - (this.Length - this.right - this.left);
        }
        this.moveLeft = moveDistance;
      } else {
        if (this.currentMin >= this.currentMax && curPoint < this.lastPoint && this.canFollow) {
          this.moveLeft = moveDistance + (this.Length - this.right - this.left);
        }
        this.moveRight = moveDistance;
      }
      this.lastPoint = curPoint;
    },
    handleEnd(e) {
      if (this.activeSlide) {
        this.left = this.Left;
        this.right = this.Right;
        this.moveLeft = 0;
        this.moveRight = 0;
        this.activeSlide = null;
        this.startPoint = null;
        this.lastPoint = null;
      }
      this.$emit('getPrice', this.currentMin, this.currentMax);
    },
    /*
     * 设置价格范围
     * this.$invoke('priceSlider', 'setPriceRange', 2000, '不限');
     */
    setPriceRange(minPrice, maxPrice) {
      this.currentMin = minPrice;
      this.currentMax = (maxPrice == '不限') ? this.maxVal : maxPrice;
      this.left = this.getLeftByPrice.call(this, this.currentMin);
      this.right = this.getRightByPrice.call(this, this.currentMax);
    },
    /*
     * 重置价格
     * this.$invoke('priceSlider', 'resetPrice');
     */
    resetPrice() {
      this.setPriceRange.call(this, this.minVal, this.maxVal);
    }
  },
  components: {
  },
  mounted: function () {},
  created: function () {
    this.scale = document.documentElement.clientWidth / 375;
    this.setPriceRange.call(this, this.currentMin, this.currentMax);
  },
};
</script>
<style lang="scss" type="text/scss" scoped>
@import "../../common/css/utils";
  .comp-priceslider{
    display: flex;
    justify-content: center;
    align-items:center;
    flex-direction: column;
    background: #FFFFFF;
    box-shadow: 0 0 rem(16, 750) 0 rgba(0,0,0,0.10);
    padding: rem(55, 750) 0 rem(55, 750);
  }

  .comp-text{
    display: flex;
    align-items:center;
    font-size: rem(28, 750);
    line-height:rem(28, 750);
    margin-bottom: rem(18, 750);
    .com-price{
      font-size: rem(28, 750);
      margin-left:rem(10, 750);
    }
  }

  .comp-outer{
    position: relative;
    display: flex;
    align-items: center;
    height: rem(56, 750);    
    padding: 0 rem(56, 750);
    touch-action: none;
  }

  .comp-line{
    position: relative;
    width: rem(400, 750);
    height: rem(8, 750);
    border-radius: rem(12, 750);
    .comp-mask{
      position: absolute;
      top: 0;
      height: rem(8, 750);
      background: #D8D8D8;
    }

    .comp-mask-left{
      left: rem(-50, 750);
      border-radius: rem(12, 750) 0 0 rem(12, 750);
    }

    .comp-mask-right{
      right: rem(-50, 750);
      border-radius: 0 rem(12, 750) rem(12, 750) 0;
    }
  }

  .comp-slider{
    position: absolute;
    width: rem(56, 750);
    height: rem(56, 750);
    box-sizing: border-box;
    top: 0;
    background: url('./assets/image/ic_slider.png') no-repeat;    
    background-size: cover;
    box-shadow: 0 0 rem(10, 750) #ddd;
    border-radius: 100%;  
  }
  .comp-slider.left {
    left: 0;
  }
  .comp-slider.right {
    right: 0;
  }
  .svg{
    background: url('./assets/image/slider.svg') no-repeat;
    background-size: cover; 
  }
</style>
